---
- name: Rolling Update Strategy
  block:
    - name: Display image info
      debug:
        msg: |
          image tag: {{ new_erpnext_image_tag }}
          release name: {{ helm_release_name }}
          namespace: {{ kubernetes_namespace }}
          chart: {{ helm_chart_path }}

    - name: Update Helm values for rolling strategy
      set_fact:
        helm_values:
          deploymentStrategy:
            type: rolling
            parameters:
              maxUnavailable: 0
              maxSurge: 1

    - name: Deploy/upgrade ERPNext with rolling strategy
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        kubeconfig_path: "{{ kubeconfig }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        values: "{{ helm_values }}"
        set_values:
          - value: "image.tag={{ new_erpnext_image_tag }}"
            value_type: string
        state: present
        wait: true
        wait_timeout: 600s
        atomic: true  # Automatically rolls back on failure
      register: helm_release

    - name: Debug helm release output
      debug:
        msg: "Helm release status: {{ helm_release.status | default('unknown') }}"

    - name: Read helm values file
      ansible.builtin.slurp:
        src: "{{ helm_chart_path }}/values.yaml"
      register: helmchart_values_raw

    - name: Parse values into a fact
      ansible.builtin.set_fact:
        helmchart_values: "{{ helmchart_values_raw.content | b64decode | from_yaml }}"

    - name: Display debug message
      ansible.builtin.debug:
        msg: "tenant https://{{ helmchart_values.ingress.hosts[0].host }}"

    - name: Ping first tenant until it's available
      ansible.builtin.get_url:
        url: "https://{{ helmchart_values.ingress.hosts[0].host }}"
        timeout: 3
      register: tenant_check
      retries: 60
      delay: 2
      until: tenant_check.status_code is defined and tenant_check.status_code < 500
      when: helm_release is succeeded


    - name: Display release status
      debug:
        msg: "Helm release status: {{ helm_release.status }}"

  rescue:
    - name: Display rollback message
      debug:
        msg: "Deployment failed. Helm atomic rollback should have been triggered automatically."
      when: helm_release is failed

    - name: Manual rollback if atomic failed
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ helm_release_name }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        state: present
      register: rollback_result
      ignore_errors: true
      when: helm_release is failed

    - name: Get rollback status
      command: "helm rollback {{ helm_release_name }} 0 -n {{ kubernetes_namespace }}"
      register: helm_rollback
      ignore_errors: true
      when: rollback_result is failed

    - name: Display fail message
      fail:
        msg: "Deployment failed and rollback was attempted. Check 'helm history {{ helm_release_name }} -n {{ kubernetes_namespace }}' for details."
      when: helm_release is failed
    
    - name: Display success message
      ansible.builtin.debug:
        msg: "Deployment successful, URL of tenant is https://{{ helmchart_values.ingress.hosts[0].host }}"