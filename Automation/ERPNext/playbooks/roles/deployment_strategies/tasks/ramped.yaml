---
- name: Ramped Update Strategy (Controlled Rolling)
  block:

    - name: Display strategy info
      debug:
        msg: |
          RAMPED STRATEGY deployment
          image tag: {{ new_erpnext_image_tag }}
          release name: {{ helm_release_name }}
          namespace: {{ kubernetes_namespace }}
          chart: {{ helm_chart_path }}

    - name: Load existing Helm values
      ansible.builtin.slurp:
        src: "{{ helm_chart_path }}/values.yaml"
      register: helmchart_values_raw

    - name: Parse existing values into a fact
      ansible.builtin.set_fact:
        existing_helm_values: "{{ helmchart_values_raw.content | b64decode | from_yaml }}"

    - name: Define the helm values patch
      ansible.builtin.set_fact:
        helm_patch:
          image:
            tag: "{{ new_erpnext_image_tag }}"
          deploymentStrategy:
            type: 
              type: RollingUpdate  # This maps to .Values.deploymentStrategy.type
              rollingUpdate:
                maxUnavailable: 1
                maxSurge: 2

    - name: Merge ramped strategy with existing values
      ansible.builtin.set_fact:
        helm_values: "{{ existing_helm_values | combine(helm_patch, recursive=True) }}"

    - name: Deploy/upgrade ERPNext with rolling strategy
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        kubeconfig_path: "{{ kubeconfig }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        values: "{{ helm_values }}"
        state: present
        wait: true
        wait_timeout: 600s
        atomic: true  # Automatically rolls back on failure
      register: helm_release

      # ==================== WAIT FOR JOBS ====================
    - name: Wait for jobs to be completed
      ansible.builtin.include_tasks: shared/wait-for-jobs.yaml

      # ==================== PING FIRST TENANT ====================
    - name: Ping first tenant until it's available
      ansible.builtin.include_tasks: shared/healthcheck-first-tenant.yaml

  rescue:
    - name: Confirm rollback deployment
      pause:
        prompt: |
          -------------- ROLLBACK AFTER HELM FAILURE --------------
          Press enter to continue or Ctrl+C to abort
      when: helm_release is failed

    - name: Manual rollback if atomic failed
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ helm_release_name }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        state: present
      register: rollback_result
      ignore_errors: true
      when: helm_release is failed

    - name: Get rollback status
      command: "helm rollback {{ helm_release_name }} 0 -n {{ kubernetes_namespace }}"
      register: helm_rollback
      ignore_errors: true
      when: rollback_result is failed

    - name: Display fail message
      fail:
        msg: "Deployment failed and rollback was attempted. Check 'helm history {{ helm_release_name }} -n {{ kubernetes_namespace }}' for details."
      when: helm_release is failed