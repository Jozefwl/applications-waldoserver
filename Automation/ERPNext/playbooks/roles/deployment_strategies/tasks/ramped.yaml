---
- name: Ramped Update Strategy (Controlled Rolling)
  block:

    - name: Display strategy info
      debug:
        msg: |
          RAMPED STRATEGY deployment
          image tag: {{ new_erpnext_image_tag }}
          release name: {{ helm_release_name }}
          namespace: {{ kubernetes_namespace }}
          chart: {{ helm_chart_path }}

    - name: Load existing Helm values
      ansible.builtin.slurp:
        src: "{{ helm_chart_path }}/values.yaml"
      register: helmchart_values_raw

    - name: Parse existing values
      ansible.builtin.set_fact:
        existing_helm_values: "{{ helmchart_values_raw.content | b64decode | from_yaml }}"

    - name: Merge ramped strategy into existing values
      ansible.builtin.set_fact:
        helm_values: >-
          {{
            existing_helm_values
            | combine({
                'deploymentStrategy': {
                  'type': 'ramped',
                  'parameters': {
                    'maxUnavailable': 1,
                    'maxSurge': 0
                  }
                }
              }, recursive=True)
          }}

    - name: Deploy/upgrade ERPNext with RAMPED strategy
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        kubeconfig_path: "{{ kubeconfig }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        values: "{{ helm_values }}"
        set_values:
          - value: "image.tag={{ new_erpnext_image_tag }}"
            value_type: string
        state: present
        wait: true
        wait_timeout: 600s
        atomic: true
      register: helm_release

    - name: Re-read values.yaml (updated)
      ansible.builtin.slurp:
        src: "{{ helm_chart_path }}/values.yaml"
      register: helmchart_values_raw

    - name: Parse merged values back into fact
      ansible.builtin.set_fact:
        helmchart_values: "{{ helmchart_values_raw.content | b64decode | from_yaml }}"

    # -----------------------------------------------------------
    # JOB WAITING LOGIC
    # -----------------------------------------------------------

    - name: Get all jobs in namespace
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Job
        namespace: "{{ kubernetes_namespace }}"
      register: all_jobs

    - name: Wait for each job to complete
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Job
        namespace: "{{ kubernetes_namespace }}"
        name: "{{ item.metadata.name }}"
      loop: "{{ all_jobs.resources }}"
      register: job_wait
      until:
        - job_wait.resources[0].status.succeeded | default(0) > 0
      retries: 100
      delay: 7
      loop_control:
        label: "{{ item.metadata.name }}"

    # -----------------------------------------------------------
    # ROLLOUT CHECKING
    # -----------------------------------------------------------

    - name: Monitor ramped rollout (waiting for all replicas updated & ready)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: "{{ kubernetes_namespace }}"
        name: "{{ helm_release_name }}-nginx"
      register: deployme
