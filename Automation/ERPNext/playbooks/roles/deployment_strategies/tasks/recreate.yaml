---
- name: Recreate Strategy
  block:
    - name: Display strategy info
      debug:
        msg: |
          Deploying with RECREATE strategy
          !!! WARNING: This will cause full downtime !!!

    - name: Confirm recreate deployment
      pause:
        prompt: |
          Press enter to continue or Ctrl+C to abort
      when: not (force_recreate | default(false) | bool)

    - name: Load existing Helm values
      ansible.builtin.slurp:
        src: "{{ helm_chart_path }}/values.yaml"
      register: helmchart_values_raw

    - name: Parse existing values into a fact
      ansible.builtin.set_fact:
        existing_helm_values: "{{ helmchart_values_raw.content | b64decode | from_yaml }}"

    - name: Define the helm values patch
      ansible.builtin.set_fact:
        helm_patch:
          image:
            tag: "{{ new_erpnext_image_tag }}"
          deploymentStrategy:
            type: 
              type: Recreate  # This maps to .Values.deploymentStrategy.type

    - name: Merge recreate strategy with existing values
      ansible.builtin.set_fact:
        helm_values: "{{ existing_helm_values | combine(helm_patch, recursive=True) }}"

    - name: Deploy/upgrade ERPNext with recreate strategy
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        values: "{{ helm_values }}"
        state: present
        wait: true
        wait_timeout: 600s
        atomic: true
      register: helm_release

    - name: Wait for all jobs in namespace to complete
      block:
        - name: Get all jobs in namespace
          kubernetes.core.k8s_info:
            kubeconfig: "{{ kubeconfig }}"
            kind: Job
            namespace: "{{ kubernetes_namespace }}"
          register: all_jobs

        - name: Wait for each job to complete
          kubernetes.core.k8s_info:
            kubeconfig: "{{ kubeconfig }}"
            kind: Job
            namespace: "{{ kubernetes_namespace }}"
            name: "{{ item.metadata.name }}"
          loop: "{{ all_jobs.resources }}"
          register: job_wait
          until: 
            - job_wait.resources[0].status.succeeded | default(0) > 0 or job_wait.resources[0].status.failed | default(0) > 0
          retries: 100
          delay: 7
          loop_control:
            label: "{{ item.metadata.name }}"
      when: all_jobs.resources | default([]) | length > 0

    - name: Ping first tenant until it's available
      ansible.builtin.shell: |
        curl -s -o /dev/null -w "%{http_code}" "https://{{ helm_values.ingress.hosts[0].host }}/"
      register: tenant_check
      retries: 100
      delay: 5
      until: tenant_check.stdout | int < 400
      when: helm_release is succeeded

    - name: Record downtime duration
      debug:
        msg: "Downtime occurred during recreate deployment. Check logs for duration."

  rescue:
    - name: Confirm rollback deployment
      pause:
        prompt: |
          -------------- ROLLBACK AFTER HELM FAILURE --------------
          Press enter to continue or Ctrl+C to abort
      when: helm_release is failed

    - name: Rollback on failure
      kubernetes.core.helm:
        name: "{{ helm_release_name }}"
        release_namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        state: present
      register: rollback_result
      ignore_errors: true