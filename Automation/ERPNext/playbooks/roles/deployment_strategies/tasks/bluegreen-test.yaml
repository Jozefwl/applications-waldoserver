---
- name: Blue/Green Strategy
  block:
    - name: Display strategy info
      debug:
        msg: |
          Starting Blue/Green Deployment
          Image tag: {{ new_erpnext_image_tag }}
          Release: {{ helm_release_name }}
          Namespace: {{ kubernetes_namespace }}
    
    # ==================== DETERMINE ENVIRONMENT ====================
    - name: Gather information of Green chart
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ helm_release_name }}-green"
        release_namespace: "{{ kubernetes_namespace }}"
      register: greenchart
      failed_when: false

    - name: Gather information of Blue chart
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ helm_release_name }}-blue"
        release_namespace: "{{ kubernetes_namespace }}"
      register: bluechart
      failed_when: false

    - name: Check deployment status
      ansible.builtin.set_fact:
        green_deployed: "{{ greenchart.status is defined and greenchart.status.status == 'deployed' }}"
        blue_deployed: "{{ bluechart.status is defined and bluechart.status.status == 'deployed' }}"
    
    - name: Handle both environments deployed
      block:
        - name: Both environments deployed - run cleanup
          ansible.builtin.include_tasks: previewslot/cleanup-slots.yaml
          
        - name: Exit after cleanup
          ansible.builtin.meta: end_play
      when: green_deployed and blue_deployed

    - name: Determine current and target environment
      ansible.builtin.set_fact:
        current_env: "{{ 'green' if green_deployed else 'blue' if blue_deployed else 'none' }}"
        target_env: "{{ 'blue' if green_deployed else 'green' }}"
        active_release: "{{ helm_release_name + '-green' if green_deployed else helm_release_name + '-blue' if blue_deployed else 'none' }}"
        target_release: "{{ helm_release_name + '-blue' if green_deployed else helm_release_name + '-green' }}"

    - name: Display environment transition
      ansible.builtin.debug:
        msg: |
          ===========================================
          Blue-Green Deployment Status
          ===========================================
          Please look at your (Free/Open)Lens to see progress...
          Current Active: {{ current_env }} ({{ active_release }})
          Deploying To: {{ target_env }} ({{ target_release }})
          ===========================================

    # ==================== DEPLOY NEW ENVIRONMENT ====================
    - name: Deploy {{ target_env }} environment
      kubernetes.core.helm:
        name: "{{ target_release }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        values_files:
          - "{{ helm_chart_path }}/values.yaml"
        values:
          environment:
            name: "{{ target_env }}"
          ingress:
            enabled: false  # Disable ingress in helm, we manage it externally
          image:
            tag: "{{ new_erpnext_image_tag }}"
        wait: true
        wait_timeout: 10m
        state: present

    - name: Check if production ingress exists
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Ingress
        namespace: "{{ kubernetes_namespace }}"
        name: erpnext-production
      register: prod_ingress
      failed_when: false

    # ==================== DEPLOY/UPDATE PRODUCTION INGRESS ====================
    - name: Apply production ingress (pointing to {{ target_env }})
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: erpnext-production
            namespace: "{{ kubernetes_namespace }}"
            annotations:
              kubernetes.io/ingress.class: traefik
              cert-manager.io/cluster-issuer: letsencrypt-prod
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
              traefik.ingress.kubernetes.io/router.tls: "true"
          spec:
            ingressClassName: traefik
            tls:
              - secretName: erpnext-tls
                hosts:
                  - tenant1.erp.waldhauser.sk
                  - tenant2.erp.waldhauser.sk
                  - tenant3.erp.waldhauser.sk
            rules:
              - host: tenant1.erp.waldhauser.sk
                http:
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
                      backend:
                        service:
                          name: "{{ target_release }}-erpnext"
                          port:
                            number: 8080
              - host: tenant2.erp.waldhauser.sk
                http:
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
                      backend:
                        service:
                          name: "{{ target_release }}-erpnext"
                          port:
                            number: 8080
              - host: tenant3.erp.waldhauser.sk
                http:
                  paths:
                    - path: /
                      pathType: ImplementationSpecific
                      backend:
                        service:
                          name: "{{ target_release }}-erpnext"
                          port:
                            number: 8080
      when: first_install | bool

      # ==================== WAIT FOR JOBS ====================
    - name: Wait for jobs to be completed
      ansible.builtin.include_tasks: shared/wait-for-jobs.yaml

      # ==================== SETUP PREVIEW  SLOT ====================
    - name: Setup preview slot
      #ansible.builtin.include_tasks: previewslot/setup-preview-ingress.yaml
      ansible.builtin.include_tasks: previewslot/previewtest2.yaml
      when: not (first_install | bool)

      # ==================== CREATE TENANTS ====================
    - name: Create additional tenants
      ansible.builtin.include_tasks: extra-tenants.yaml
      when: first_install | bool

      # ==================== SYNCHRONIZE PVCs ====================
    - name: Synchronize PVCs and credentials
      ansible.builtin.include_tasks: previewslot/synchronize-pvcs.yaml
      when: not (first_install | bool)

    # ==================== SWITCH PRODUCTION ====================
    - name: Switch production traffic
      ansible.builtin.include_tasks: previewslot/switch-production-traffic.yaml
      when: not (first_install | bool)

    # ==================== CLEANUP ====================
    - name: Cleanup old environment
      ansible.builtin.include_tasks: previewslot/cleanup-old.yaml
      when: not (first_install | bool)

  