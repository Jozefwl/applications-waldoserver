---
# sync-pvc-canary.yaml
# Synchronizes PVC from stable release to canary release
# Usage: include this task with vars: source_release and dest_release

- name: Display PVC sync info
  debug:
    msg: "Syncing PVC from {{ source_release }} to {{ dest_release }}"

- name: Set PVC names
  set_fact:
    source_pvc: "{{ source_release }}-{{ kubernetes_namespace }}"
    dest_pvc: "{{ dest_release }}"

- name: Check if source PVC exists
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    name: "{{ source_pvc }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
  register: source_pvc_check
  failed_when: source_pvc_check.resources | length == 0

- name: Check if destination PVC exists
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    name: "{{ dest_pvc }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
  register: dest_pvc_check

- name: Create destination PVC if it doesn't exist
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ dest_pvc }}"
        namespace: "{{ kubernetes_namespace }}"
        labels:
          app: "{{ dest_release }}"
          release: "{{ dest_release }}"
      spec:
        accessModes: "{{ source_pvc_check.resources[0].spec.accessModes }}"
        resources:
          requests:
            storage: "{{ source_pvc_check.resources[0].spec.resources.requests.storage }}"
        storageClassName: "{{ source_pvc_check.resources[0].spec.storageClassName | default(omit) }}"
  when: dest_pvc_check.resources | length == 0

- name: Wait for destination PVC to be bound
  kubernetes.core.k8s_info:
    kind: PersistentVolumeClaim
    name: "{{ dest_pvc }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
  register: dest_pvc_status
  until: dest_pvc_status.resources[0].status.phase == "Bound"
  retries: 30
  delay: 2
  when: dest_pvc_check.resources | length == 0

- name: Delete old sync job if it exists
  kubernetes.core.k8s:
    state: absent
    kind: Job
    name: "sync-{{ source_release | regex_replace('-', '') }}-to-{{ dest_release | regex_replace('-', '') }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
  ignore_errors: yes

- name: Wait for cleanup
  pause:
    seconds: 5

- name: Create PVC sync job
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig }}"
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: "sync-{{ source_release | regex_replace('-', '') }}-to-{{ dest_release | regex_replace('-', '') }}"
        namespace: "{{ kubernetes_namespace }}"
        labels:
          app: pvc-sync
          source: "{{ source_release }}"
          destination: "{{ dest_release }}"
      spec:
        backoffLimit: 2
        ttlSecondsAfterFinished: 3600
        template:
          spec:
            serviceAccountName: default
            containers:
            - name: sync
              image: alpine:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e
                  
                  echo "============================================"
                  echo "PVC SYNC: {{ source_release }} -> {{ dest_release }}"
                  echo "============================================"
                  
                  apk add --no-cache rsync python3
                  
                  # Verify source exists
                  if [ ! -d "/src/frappe-bench" ]; then
                    echo "ERROR: Source directory not found at /src/frappe-bench"
                    exit 1
                  fi
                  
                  # Create destination structure if needed
                  mkdir -p /dst/frappe-bench
                  
                  echo ""
                  echo "Source contents:"
                  ls -lah /src/frappe-bench/ | head -20
                  
                  echo ""
                  echo "Destination contents (before sync):"
                  ls -lah /dst/frappe-bench/ | head -20
                  
                  echo ""
                  echo "Starting rsync..."
                  rsync -avz \
                    --delete \
                    --ignore-errors \
                    --exclude="*.pyc" \
                    --exclude="__pycache__" \
                    --exclude="*.sock" \
                    --exclude="site_config.json" \
                    /src/frappe-bench/ /dst/frappe-bench/
                  
                  echo ""
                  echo "Rsync completed. Processing site configs..."
                  
                  # Copy database credentials from source to destination
                  python3 << 'PYEOF'
                  import json
                  from pathlib import Path
                  import sys
                  
                  base_src = Path("/src/frappe-bench")
                  base_dst = Path("/dst/frappe-bench")
                  skip_dirs = {'assets', 'sites', 'config', 'apps', 'env', 'logs', 'archived'}
                  
                  synced_sites = 0
                  errors = []
                  
                  print("\n" + "="*50)
                  print("SITE CONFIGURATION SYNC")
                  print("="*50)
                  
                  # Get all site directories from source
                  for src_site_dir in base_src.iterdir():
                      if not src_site_dir.is_dir() or src_site_dir.name in skip_dirs:
                          continue
                      
                      site_name = src_site_dir.name
                      src_config = src_site_dir / "site_config.json"
                      dst_site_dir = base_dst / site_name
                      dst_config = dst_site_dir / "site_config.json"
                      
                      print(f"\nProcessing: {site_name}")
                      
                      if not src_config.exists():
                          print(f"  [WARN] Source config not found, skipping")
                          continue
                      
                      try:
                          # Read source config
                          with open(src_config, 'r') as f:
                              src_data = json.load(f)
                          
                          # Extract critical DB credentials
                          db_password = src_data.get('db_password')
                          if not db_password:
                              print(f"  [WARN] No db_password in source config")
                              continue
                          
                          # Ensure destination directory exists
                          dst_site_dir.mkdir(parents=True, exist_ok=True)
                          
                          # Read or create destination config
                          if dst_config.exists():
                              with open(dst_config, 'r') as f:
                                  dst_data = json.load(f)
                          else:
                              dst_data = {}
                          
                          # Update database credentials
                          dst_data['db_password'] = db_password
                          dst_data['db_name'] = src_data.get('db_name', f'{site_name}_db')
                          dst_data['db_host'] = src_data.get('db_host', 'mariadb.dbs.svc.cluster.local')
                          dst_data['db_port'] = src_data.get('db_port', 3306)
                          dst_data['db_type'] = src_data.get('db_type', 'mariadb')
                          
                          # Preserve other important settings
                          for key in ['redis_cache', 'redis_queue', 'redis_socketio', 'socketio_port']:
                              if key in src_data:
                                  dst_data[key] = src_data[key]
                          
                          # Write destination config
                          with open(dst_config, 'w') as f:
                              json.dump(dst_data, f, indent=2)
                          
                          print(f"  [OK] Synced")
                          print(f"    Database: {dst_data['db_name']}")
                          print(f"    Host: {dst_data['db_host']}")
                          print(f"    Password: {db_password[:8]}...")
                          
                          synced_sites += 1
                          
                      except Exception as e:
                          error_msg = f"  [ERROR] {str(e)}"
                          print(error_msg)
                          errors.append(f"{site_name}: {str(e)}")
                  
                  print("\n" + "="*50)
                  print(f"SYNC SUMMARY")
                  print("="*50)
                  print(f"Sites synced: {synced_sites}")
                  
                  if errors:
                      print(f"Errors: {len(errors)}")
                      for err in errors:
                          print(f"  - {err}")
                      sys.exit(1)
                  else:
                      print("Status: SUCCESS")
                  
                  PYEOF
                  
                  SYNC_EXIT=$?
                  
                  echo ""
                  echo "============================================"
                  if [ $SYNC_EXIT -eq 0 ]; then
                    echo "✓ PVC SYNC COMPLETED SUCCESSFULLY"
                  else
                    echo "✗ PVC SYNC FAILED"
                  fi
                  echo "============================================"
                  
                  exit $SYNC_EXIT
              volumeMounts:
              - name: src
                mountPath: /src/frappe-bench
                readOnly: true
              - name: dst
                mountPath: /dst/frappe-bench
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "1Gi"
                  cpu: "1000m"
            restartPolicy: OnFailure
            volumes:
            - name: src
              persistentVolumeClaim:
                claimName: "{{ source_pvc }}"
            - name: dst
              persistentVolumeClaim:
                claimName: "{{ dest_pvc }}"

- name: Wait for sync job to complete
  kubernetes.core.k8s_info:
    kind: Job
    name: "sync-{{ source_release | regex_replace('-', '') }}-to-{{ dest_release | regex_replace('-', '') }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
  register: sync_job_status
  until: >
    (sync_job_status.resources | length > 0) and
    ((sync_job_status.resources[0].status.succeeded is defined and
    sync_job_status.resources[0].status.succeeded == 1) or
    (sync_job_status.resources[0].status.failed is defined and
    sync_job_status.resources[0].status.failed > 0))
  retries: "{{ (job_timeout | default(900) / 10) | int }}"
  delay: 10

- name: Get sync job logs
  kubernetes.core.k8s_log:
    name: "sync-{{ source_release | regex_replace('-', '') }}-to-{{ dest_release | regex_replace('-', '') }}"
    namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
    kind: Job
  register: sync_job_logs
  ignore_errors: yes

- name: Display sync logs
  debug:
    msg: "{{ sync_job_logs.log.split('\n') }}"
  when: sync_job_logs.log is defined

- name: Check if sync job failed
  fail:
    msg: |
      PVC sync job failed!
      Check logs above for details.
  when: >
    sync_job_status.resources[0].status.failed is defined and
    sync_job_status.resources[0].status.failed > 0

- name: PVC sync completed
  debug:
    msg: "✓ PVC sync successful: {{ source_release }} -> {{ dest_release }}"