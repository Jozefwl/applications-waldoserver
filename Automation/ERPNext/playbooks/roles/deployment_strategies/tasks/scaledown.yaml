- name: Transition to blue/green - Scale down old deployment
  block:
    - name: Get all old ERPNext deployments
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: "{{ kubernetes_namespace }}"
        label_selectors:
          - "app.kubernetes.io/instance={{ helm_release_name }}"
      register: all_deployments

    - name: Display old deployments info
      debug:
        msg: |
          Found {{ all_deployments.resources | length }} deployments to scale down:
          {% for deployment in all_deployments.resources %}
          - {{ deployment.metadata.name }}: {{ deployment.spec.replicas | default(0) }} replicas
          {% endfor %}

    # Scale down all old deployments to 0
    - name: Scale down all old deployments to 0 replicas
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        api_version: apps/v1
        name: "{{ item.metadata.name }}"
        namespace: "{{ kubernetes_namespace }}"
        definition:
          spec:
            replicas: 0
        state: present
      loop: "{{ all_deployments.resources }}"
      when: all_deployments.resources | length > 0

    - name: Wait for all old deployment pods to terminate
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Pod
        namespace: "{{ kubernetes_namespace }}"
        label_selectors:
          - "app.kubernetes.io/instance={{ helm_release_name }}"
          - "app.kubernetes.io/name notin (mariadb,redis-cache,redis-queue)"
      register: old_pods
      until: old_pods.resources | length == 0
      retries: 60
      delay: 2


    - name: Display scaling result
      debug:
        msg: |
          All {{ all_deployments.resources | length }} deployments scaled to 0 replicas
          All {{ all_deployments.resources | map(attribute='metadata.name') | list }} pods have terminated
          MariaDB and Redis StatefulSets remain running
