# ==================== SWITCH PRODUCTION TRAFFIC TO BLUE/GREEN ====================
# This switches production traffic from current environment to the blue/green environment

- name: Confirm traffic switch (if not force)
  ansible.builtin.pause:
    prompt: |
      
      ════════════════════════════════════════════════════════════════════════════════════
      Ready to Switch Production Traffic
      ════════════════════════════════════════════════════════════════════════════════════
      Current Environment: {{ current_env | upper if current_env != 'none' else 'NONE (First deployment)' }}
      Switch To Environment: {{ target_env | upper }}
      Service: {{ helm_release_name }}-{{ target_env }}-erpnext:8080
      
      Production Domains:
      {% for mapping in preview_domain_mapping %}
      - {{ mapping.production }}
      {% endfor %}
      ════════════════════════════════════════════════════════════════════════════════════
      
      Press ENTER to switch production traffic to {{ target_env | upper }}
      Or Ctrl+C then 'A' to abort
  when: not force_switch | default(false)

- name: Create/Update preview IngressRoutes (pointing to {{ current_env }})
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: "erpnext-preview-{{ item.production | replace('.', '-') }}"
        namespace: "{{ kubernetes_namespace }}"
        labels:
          domain: "{{ item.preview }}"
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "Host(`{{ item.preview }}`)"
            kind: Rule
            services:
              - name: "{{ helm_release_name }}-{{ current_env }}-erpnext"
                port: 8080
            middlewares:
              - name: "preview-rewrite-{{ item.production | replace('.', '-') }}"
                namespace: "{{ kubernetes_namespace }}"
        tls:
          secretName: "{{ preview_tls_secret_name }}"
  loop: "{{ preview_domain_mapping }}"
  loop_control:
    extended: yes

- name: Apply production ingress (pointing to {{ target_env }})
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: erpnext-production
        namespace: "{{ kubernetes_namespace }}"
        labels:
          environment: production
        annotations:
          kubernetes.io/ingress.class: traefik
          cert-manager.io/cluster-issuer: letsencrypt-prod
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
          traefik.ingress.kubernetes.io/router.tls: "true"
      spec:
        ingressClassName: traefik
        tls:
          - secretName: erpnext-tls
            hosts:
              - tenant1.erp.waldhauser.sk
              - tenant2.erp.waldhauser.sk
              - tenant3.erp.waldhauser.sk
        rules:
          - host: tenant1.erp.waldhauser.sk
            http:
              paths:
                - path: /
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: "{{ helm_release_name }}-{{ target_env }}-{{ kubernetes_namespace }}"
                      port:
                        number: 8080
          - host: tenant2.erp.waldhauser.sk
            http:
              paths:
                - path: /
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: "{{ helm_release_name }}-{{ target_env }}-{{ kubernetes_namespace }}"
                      port:
                        number: 8080
          - host: tenant3.erp.waldhauser.sk
            http:
              paths:
                - path: /
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: "{{ helm_release_name }}-{{ target_env }}-{{ kubernetes_namespace }}"
                      port:
                        number: 8080

- name: Verify production endpoints
  ansible.builtin.uri:
    url: "https://{{ item.production }}/api/v2/method/ping"
    validate_certs: no
    status_code: 200
    timeout: 10
  register: prod_check
  retries: 10
  delay: 3
  ignore_errors: yes
  loop: "{{ preview_domain_mapping }}"

