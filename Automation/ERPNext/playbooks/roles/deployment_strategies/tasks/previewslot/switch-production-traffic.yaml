# ==================== SWITCH PRODUCTION TRAFFIC TO BLUE/GREEN ====================
# This switches production traffic from current environment to the blue/green environment

- name: Confirm traffic switch (if not force)
  ansible.builtin.pause:
    prompt: |
      
      ════════════════════════════════════════════════════════════════════════════════════
      Ready to Switch Production Traffic
      ════════════════════════════════════════════════════════════════════════════════════
      Current Environment: {{ current_env | upper if current_env != 'none' else 'NONE (First deployment)' }}
      Switch To Environment: {{ target_env | upper }}
      Service: {{ helm_release_name }}-{{ target_env }}-erpnext:8080
      
      Production Domains:
      {% for mapping in preview_domain_mapping %}
      - {{ mapping.production }}
      {% endfor %}
      ════════════════════════════════════════════════════════════════════════════════════
      
      Press ENTER to switch production traffic to {{ target_env | upper }}
      Or Ctrl+C then 'A' to abort
  when: not force_switch | default(false)


- name: Create/Update production IngressRoutes (TraefikIngressRoute)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: "erpnext-production-{{ item.production | replace('.', '-') }}"
        namespace: "{{ kubernetes_namespace }}"
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "Host(`{{ item.production }}`)"
            kind: Rule
            services:
              - name: "{{ helm_release_name }}-{{ target_env }}-erpnext"
                port: 8080
        tls:
          secretName: "{{ preview_tls_secret_name }}"
  loop: "{{ preview_domain_mapping }}"


- name: Display production traffic configuration
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════════════════════════════════
      ✓ Production IngressRoutes Created
      ════════════════════════════════════════════════════════════════════════════════════
      
      Active Environment: {{ target_env | upper }}
      Service: {{ helm_release_name }}-{{ target_env }}-erpnext:8080
      
      Production Routing:
      {% for mapping in preview_domain_mapping %}
      https://{{ mapping.production }}
        ↓
      {{ helm_release_name }}-{{ target_env }}-erpnext:8080 ✓
      {% endfor %}
      
      Preview Routing (unchanged):
      {% for mapping in preview_domain_mapping %}
      https://{{ mapping.preview }}
        ↓
      preview-nginx-proxy:9090 (Host rewrite)
        ↓
      {{ helm_release_name }}-{{ target_env }}-erpnext:8080 ✓
      {% endfor %}
      ════════════════════════════════════════════════════════════════════════════════════


- name: Wait for production ingress to propagate
  ansible.builtin.pause:
    seconds: 10


- name: Verify production endpoints
  ansible.builtin.uri:
    url: "https://{{ item.production }}/api/method/frappe.ping"
    validate_certs: no
    status_code: 200
    timeout: 10
  register: prod_check
  retries: 10
  delay: 3
  ignore_errors: yes
  loop: "{{ preview_domain_mapping }}"


- name: Display production traffic switch results
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════════════════════════════════
      ✓ Production Traffic Switched Successfully!
      ════════════════════════════════════════════════════════════════════════════════════
      
      Active Environment: {{ target_env | upper }}
      Service: {{ helm_release_name }}-{{ target_env }}-erpnext:8080
      
      Production Health Check:
      {% for result in prod_check.results %}
      {{ result.item.production }}: {{ '✓ HEALTHY (200 OK)' if result.status == 200 else '✗ FAILED (' + result.status|string + ')' }}
      {% endfor %}
      
      Summary:
      ✓ Preview routes continue to use nginx proxy with Host rewriting
      ✓ Production routes now point to {{ target_env | upper }} environment
      ✓ Old environment traffic fully switched
      ✓ Both environments can coexist independently
      
      To rollback: Run deployment with: current_env={{ target_env }} target_env={{ current_env }}
      ════════════════════════════════════════════════════════════════════════════════════