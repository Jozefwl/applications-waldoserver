---
# ==================== CLEANUP OLD ENVIRONMENT ====================
- name: Confirm cleanup
  ansible.builtin.pause:
    prompt: "Press ENTER to remove old {{ current_env | upper }} environment, or Ctrl+C then A to keep it"
  when: 
    - current_env != 'none'
    - not cleanup_old_env

- name: Remove sync jobs that bind PVCs
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    namespace: "{{ kubernetes_namespace }}"
    state: absent
    kind: Job
    name: "{{ item }}"
  loop:
    - "sync-green-to-blue"
    - "sync-blue-to-green"
  ignore_errors: true
  when: current_env != 'none'

- name: Remove old environment
  kubernetes.core.helm:
    name: "{{ helm_release_name }}-{{ current_env }}"
    release_namespace: "{{ kubernetes_namespace }}"
    kubeconfig: "{{ kubeconfig }}"
    state: absent
    wait: true
  when: current_env != 'none'

- name: Deployment complete
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════
      [SUCCESS] DEPLOYMENT COMPLETE
      ════════════════════════════════════════
      Active: {{ target_env | upper }}
      Removed: {{ current_env | upper if current_env != 'none' else 'N/A' }}
      Image: {{ new_erpnext_image_tag }}
      ════════════════════════════════════════