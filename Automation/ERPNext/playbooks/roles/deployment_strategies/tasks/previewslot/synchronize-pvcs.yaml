---
- name: Sync PVCs from active to target environment
  block:
    - name: Gather facts for timestamp
      setup:
        gather_subset:
          - min

    - name: Figure out source and destination
      set_fact:
        source_env: "{{ 'green' if target_env == 'blue' else 'blue' }}"
        dest_env: "{{ target_env }}"

    - name: Display synchronization status
      debug:
        msg: "Syncing from {{ source_env }} to {{ dest_env }}"

    - name: Delete old sync job if it exists
      kubernetes.core.k8s:
        state: absent
        kind: Job
        name: "sync-{{ source_env }}-to-{{ dest_env }}"
        namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      ignore_errors: yes

    - name: Wait a bit for cleanup
      pause:
        seconds: 10

    - name: Create and run sync job
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: "sync-{{ source_env }}-to-{{ dest_env }}"
            namespace: "{{ kubernetes_namespace }}"
          spec:
            backoffLimit: 3
            ttlSecondsAfterFinished: 3600
            template:
              spec:
                serviceAccountName: default
                containers:
                - name: sync
                  image: alpine:latest
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      apk add --no-cache rsync python3
                      
                      echo "Syncing from {{ source_env | upper }} to {{ dest_env | upper }}..."
                      
                      if [ ! -d "/src/frappe-bench" ]; then
                        echo "ERROR: Source not found"
                        exit 1
                      fi
                      
                      echo "Source:"
                      ls -la /src/frappe-bench/
                      echo ""
                      echo "Destination:"
                      ls -la /dst/frappe-bench/
                      echo ""
                      
                      echo "Syncing files..."
                      rsync -avz --delete --ignore-errors --exclude="site_config.json" /src/frappe-bench/ /dst/frappe-bench/
                      
                      echo "Copying DB credentials..."
                      python3 << 'EOF'
                      import json
                      from pathlib import Path
                      
                      base = "/dst/frappe-bench"
                      src = "/src/frappe-bench"
                      skip = ['assets', 'sites', 'config', 'apps', 'env', 'logs']
                      
                      for item in Path(base).iterdir():
                          if not item.is_dir() or item.name in skip:
                              continue
                          
                          site = item.name
                          dst_cfg = item / "site_config.json"
                          src_cfg = Path(src) / site / "site_config.json"
                          
                          print(f"\n{site}:")
                          
                          if not src_cfg.exists():
                              print("  source config not found")
                              continue
                          
                          try:
                              with open(src_cfg) as f:
                                  src_data = json.load(f)
                              
                              db_pass = src_data.get('db_password')
                              if not db_pass:
                                  print("  no password in source")
                                  continue
                              
                              if dst_cfg.exists():
                                  with open(dst_cfg) as f:
                                      dst_data = json.load(f)
                              else:
                                  dst_data = {}
                              
                              dst_data['db_password'] = db_pass
                              dst_data['db_name'] = src_data.get('db_name')
                              dst_data['db_host'] = src_data.get('db_host', 'mariadb.dbs.svc.cluster.local')
                              dst_data['db_port'] = src_data.get('db_port', 3306)
                              dst_data['db_type'] = src_data.get('db_type', 'mariadb')
                              
                              with open(dst_cfg, 'w') as f:
                                  json.dump(dst_data, f, indent=1)
                              
                              print(f"  password: {db_pass[:10]}...")
                              print(f"  database: {dst_data['db_name']}")
                              
                          except Exception as e:
                              print(f"  error: {e}")
                      EOF
                      
                      echo ""
                      echo "Done!"
                  volumeMounts:
                  - name: src
                    mountPath: /src/frappe-bench
                  - name: dst
                    mountPath: /dst/frappe-bench
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                restartPolicy: OnFailure
                volumes:
                - name: src
                  persistentVolumeClaim:
                    claimName: "{{ helm_release_name }}-{{ source_env }}-{{ kubernetes_namespace }}"
                - name: dst
                  persistentVolumeClaim:
                    claimName: "{{ helm_release_name }}-{{ dest_env }}-{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"

    - name: Wait for job to finish
      kubernetes.core.k8s_info:
        kind: Job
        name: "sync-{{ source_env }}-to-{{ dest_env }}"
        namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: job_status
      until: >
        (job_status.resources | length > 0) and
        ((job_status.resources[0].status.succeeded is defined and
        job_status.resources[0].status.succeeded == 1) or
        (job_status.resources[0].status.failed is defined and
        job_status.resources[0].status.failed > 0))
      retries: "{{ (job_timeout | default(600) / 10) | int }}"
      delay: 10

    - name: Check if job failed
      fail:
        msg: "Sync job failed"
      when: >
        job_status.resources[0].status.failed is defined and
        job_status.resources[0].status.failed > 0

    - name: Get job logs
      kubernetes.core.k8s_log:
        name: "sync-{{ source_env }}-to-{{ dest_env }}"
        namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        kind: Job
      register: job_logs
      ignore_errors: yes

    - name: Show logs
      debug:
        msg: "{{ job_logs.log.split('\n') }}"
      when: job_logs.log is defined

    - name: Generate restart timestamp
      set_fact:
        restart_timestamp: "{{ lookup('pipe', 'date --iso-8601=seconds') }}"

    - name: Restart pods to pick up new config
      kubernetes.core.k8s:
        state: patched
        kind: Deployment
        name: "{{ helm_release_name }}-{{ dest_env }}-{{ kubernetes_namespace }}-gunicorn"
        namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        definition:
          spec:
            template:
              metadata:
                annotations:
                  kubectl.kubernetes.io/restartedAt: "{{ restart_timestamp }}"

    - name: Wait for pods to come back up
      kubernetes.core.k8s_info:
        kind: Deployment
        name: "{{ helm_release_name }}-{{ dest_env }}-{{ kubernetes_namespace }}-gunicorn"
        namespace: "{{ kubernetes_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: deploy
      until: >
        (deploy.resources | length > 0) and
        (deploy.resources[0].status.availableReplicas is defined and
        deploy.resources[0].status.availableReplicas == deploy.resources[0].spec.replicas)
      retries: "{{ (pod_ready_timeout | default(300) / 5) | int }}"
      delay: 5

    - name: Sync completed successfully
      debug:
        msg: "Sync complete - {{ source_env }} -> {{ dest_env }}"

  rescue:
    - name: Sync failed
      debug:
        msg: "Sync failed, check logs above"
    
    - name: Fail the playbook
      fail:
        msg: "PVC sync failed"