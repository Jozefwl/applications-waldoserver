# ==================== SETUP PREVIEW INGRESS WITH CERTIFICATE ====================
# Creates middleware, IngressRoute, and certificate for preview domains
# Checks if preview-tls certificate exists, creates if missing

- name: Check if preview-tls certificate exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: Certificate
    name: preview-tls
    namespace: "{{ kubernetes_namespace }}"
  register: preview_cert


- name: Create preview-tls certificate if it doesn't exist
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: preview-tls
        namespace: "{{ kubernetes_namespace }}"
      spec:
        dnsNames:
          - "preview.tenant1.erp.waldhauser.sk"
          - "preview.tenant2.erp.waldhauser.sk"
          - "preview.tenant3.erp.waldhauser.sk"
        issuerRef:
          kind: ClusterIssuer
          name: letsencrypt-prod
        secretName: preview-tls
  when: preview_cert.resources | length == 0


- name: Display certificate status
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════════════════════════════════
      Certificate Status
      ════════════════════════════════════════════════════════════════════════════════════
      {% if preview_cert.resources | length > 0 %}
      ✓ preview-tls certificate exists
      Status: {{ preview_cert.resources[0].status.conditions[0].reason if preview_cert.resources[0].status.conditions | length > 0 else 'Unknown' }}
      {% else %}
      ⚠ Creating preview-tls certificate...
      Domains:
      - preview.tenant1.erp.waldhauser.sk
      - preview.tenant2.erp.waldhauser.sk
      - preview.tenant3.erp.waldhauser.sk
      {% endif %}
      ════════════════════════════════════════════════════════════════════════════════════


- name: Create Host rewrite middleware for each preview domain
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: "rewrite-host-{{ item.production | replace('.', '-') }}"
        namespace: "{{ kubernetes_namespace }}"
      spec:
        headers:
          customRequestHeaders:
            Host: "{{ item.production }}"
  loop: "{{ preview_domain_mapping }}"


- name: Create preview IngressRoute for each tenant
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: "preview-ingressroute-{{ item.production | replace('.', '-') }}"
        namespace: "{{ kubernetes_namespace }}"
      spec:
        entryPoints:
          - websecure
        routes:
          - match: "Host(`{{ item.preview }}`)"
            kind: Rule
            services:
              - name: "{{ helm_release_name }}-{{ target_env }}-erpnext"
                port: 8080
            middlewares:
              - name: "rewrite-host-{{ item.production | replace('.', '-') }}"
                namespace: "{{ kubernetes_namespace }}"
        tls:
          secretName: preview-tls
  loop: "{{ preview_domain_mapping }}"


- name: Display preview ingress configuration
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════════════════════════════════
      ✓ Preview Ingress Routes Created
      ════════════════════════════════════════════════════════════════════════════════════
      
      Certificate: preview-tls ({{ 'Ready' if preview_cert.resources | length > 0 else 'Creating' }})
      
      Middleware:
      {% for mapping in preview_domain_mapping %}
      - rewrite-host-{{ mapping.production | replace('.', '-') }}
        Sets Host header to: {{ mapping.production }}
      {% endfor %}
      
      IngressRoutes:
      {% for mapping in preview_domain_mapping %}
      - preview-ingressroute-{{ mapping.production | replace('.', '-') }}
        Domain: {{ mapping.preview }}
        Service: {{ helm_release_name }}-{{ target_env }}-erpnext:8080
        Middleware: rewrite-host-{{ mapping.production | replace('.', '-') }}
      {% endfor %}
      
      Request Flow:
      https://preview.tenant1.erp.waldhauser.sk
        ↓ (Traefik)
      Middleware: rewrite-host-tenant1-erp-waldhauser-sk
        ↓ (Host header set to tenant1.erp.waldhauser.sk)
      {{ helm_release_name }}-{{ target_env }}-erpnext:8080 ✓
      ════════════════════════════════════════════════════════════════════════════════════


- name: Wait for ingress to be ready
  ansible.builtin.pause:
    seconds: 10


- name: Test preview endpoints
  ansible.builtin.uri:
    url: "https://{{ item.preview }}/api/method/frappe.ping"
    validate_certs: no
    status_code: 200
    timeout: 10
  register: health_check
  retries: 5
  delay: 5
  ignore_errors: yes
  loop: "{{ preview_domain_mapping }}"


- name: Display health check results
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════════════════════════════════
      Preview Health Check Results
      ════════════════════════════════════════════════════════════════════════════════════
      {% for result in health_check.results %}
      {{ result.item.preview }}: {{ '✓ HEALTHY (200 OK)' if result.status == 200 else '✗ ERROR (' + result.status|string + ')' }}
      {% endfor %}
      ════════════════════════════════════════════════════════════════════════════════════